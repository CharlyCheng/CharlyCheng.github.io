<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="一道题1234567891011121314151617181920async function async1()&amp;#123;  console.log(&amp;apos;1&amp;apos;)  await async2()  console.log(&amp;apos;2&amp;apos;)&amp;#125;async function async2()&amp;#123;  console.log(&amp;apos;3&amp;apos;)&amp;#">
<meta property="og:type" content="article">
<meta property="og:title" content="async&#x2F;await学习分享">
<meta property="og:url" content="http://yoursite.com/2018/11/30/await/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="一道题1234567891011121314151617181920async function async1()&amp;#123;  console.log(&amp;apos;1&amp;apos;)  await async2()  console.log(&amp;apos;2&amp;apos;)&amp;#125;async function async2()&amp;#123;  console.log(&amp;apos;3&amp;apos;)&amp;#">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2018/11/30/images/co1.png">
<meta property="og:image" content="http://yoursite.com/2018/11/30/images/co2.png">
<meta property="og:updated_time" content="2018-11-30T08:27:59.037Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="async&#x2F;await学习分享">
<meta name="twitter:description" content="一道题1234567891011121314151617181920async function async1()&amp;#123;  console.log(&amp;apos;1&amp;apos;)  await async2()  console.log(&amp;apos;2&amp;apos;)&amp;#125;async function async2()&amp;#123;  console.log(&amp;apos;3&amp;apos;)&amp;#">
<meta name="twitter:image" content="http://yoursite.com/2018/11/30/images/co1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/11/30/await/"/>





  <title>async/await学习分享 | Hexo</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/30/await/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">async/await学习分享</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-30T16:08:54+08:00">
                2018-11-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="一道题"><a href="#一道题" class="headerlink" title="一道题"></a>一道题</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">async function async1()&#123;</span><br><span class="line">  console.log(&apos;1&apos;)</span><br><span class="line">  await async2()</span><br><span class="line">  console.log(&apos;2&apos;)</span><br><span class="line">&#125;</span><br><span class="line">async function async2()&#123;</span><br><span class="line">  console.log(&apos;3&apos;)</span><br><span class="line">&#125;</span><br><span class="line">console.log(&apos;4&apos;)</span><br><span class="line">setTimeout(function()&#123;</span><br><span class="line">  console.log(&apos;5&apos;) </span><br><span class="line">&#125;,0)  </span><br><span class="line">async1();</span><br><span class="line">new Promise(function(resolve)&#123;</span><br><span class="line">  console.log(&apos;6&apos;)</span><br><span class="line">  resolve();</span><br><span class="line">&#125;).then(function()&#123;</span><br><span class="line">  console.log(&apos;7&apos;)</span><br><span class="line">&#125;)</span><br><span class="line">console.log(&apos;8&apos;)</span><br></pre></td></tr></table></figure>
<h3 id="理解async-await"><a href="#理解async-await" class="headerlink" title="理解async/await"></a>理解async/await</h3><p>回调函数，事件监听，事件订阅，到 Promise 对象，再到 Generator 函数，追求解决回调地狱的问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">回调函数</span><br><span class="line">getData( a =&gt; &#123;</span><br><span class="line">    getTwoData( a, b =&gt; &#123;</span><br><span class="line">        getThreeData( b,c =&gt; &#123;</span><br><span class="line">            getFourData( c, d =&gt; &#123;</span><br><span class="line">                console.log(&apos;终于嵌套完了&apos;)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">Promise改进后</span><br><span class="line">getData().then( a =&gt; &#123;</span><br><span class="line">    return getTwoData(a)</span><br><span class="line">&#125;).then( b =&gt; &#123;</span><br><span class="line">    return getThreeData(a)</span><br><span class="line">&#125;).then( c =&gt; &#123;</span><br><span class="line">    return getFourData(c)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">Generator </span><br><span class="line">function* helloWorldGenerator() &#123;</span><br><span class="line">  yield &apos;hello&apos;;</span><br><span class="line">  yield &apos;world&apos;;</span><br><span class="line">  return &apos;ending&apos;;</span><br><span class="line">&#125;</span><br><span class="line">var hw = helloWorldGenerator();</span><br><span class="line">hw.next()</span><br><span class="line">hw.next()</span><br><span class="line">hw.next()</span><br><span class="line"></span><br><span class="line">Generator 改进后+ co 模块</span><br><span class="line">const co = require(&apos;co&apos;);</span><br><span class="line">const gen = co(function* () &#123;</span><br><span class="line">  const a = yield getData();</span><br><span class="line">  const b = yield getTwoData();</span><br><span class="line">  const c = yield getThreeData();</span><br><span class="line">  const d = yield getFourData();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">async/await 改进后</span><br><span class="line">async () =&gt; &#123;</span><br><span class="line">    const a = await getData()</span><br><span class="line">    const b = await getTwoData()</span><br><span class="line">    const c = await getThreeData()</span><br><span class="line">    const d = await getFourData()</span><br><span class="line">    console.log(d)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="async"><a href="#async" class="headerlink" title="async"></a>async</h4><p>async/await可以说是co模块和生成器函数的语法糖。用更加清晰的语义解决js异步代码。<br>使用 async / await, 搭配 promise, 可以通过编写形似同步的代码来处理异步流程, 提高代码的简洁性和可读性<br><a href="http://www.charlycheng.xyz/2018/04/19/promise:A+%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%B9%B3%E6%97%B6%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/" target="_blank" rel="noopener">Promise实现</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">async function fn(args) &#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 等同于</span><br><span class="line">function fn(args) &#123;</span><br><span class="line">  return  sp(function* () &#123;</span><br><span class="line">    </span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line">function sp(genF) &#123;</span><br><span class="line">  return new Promise(function(resolve, reject) &#123;</span><br><span class="line">    const gen = genF();</span><br><span class="line">    function step(nextF) &#123;</span><br><span class="line">      let next;</span><br><span class="line">      try &#123;</span><br><span class="line">        next = nextF();</span><br><span class="line">      &#125; catch(e) &#123;</span><br><span class="line">        return reject(e);</span><br><span class="line">      &#125;</span><br><span class="line">      if(next.done) &#123;</span><br><span class="line">        return resolve(next.value);</span><br><span class="line">      &#125;</span><br><span class="line">      Promise.resolve(next.value).then(function(v) &#123;</span><br><span class="line">        step(function() &#123; return gen.next(v); &#125;);</span><br><span class="line">      &#125;, function(e) &#123;</span><br><span class="line">        step(function() &#123; return gen.throw(e); &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    step(function() &#123; return gen.next(undefined); &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>async函数会返回一个Promise对象<br>    – async函数中是return一个值，这个值就是Promise对象中resolve的值；<br>    – async函数中是throw一个值，这个值就是Promise对象中reject的值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">const imAsync = async (num) =&gt; &#123;</span><br><span class="line">  if (num &gt; 0) &#123;</span><br><span class="line">    return num // 这里相当于resolve(num)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    throw num // 这里相当于reject(num)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">imAsync(1).then( v =&gt; &#123;</span><br><span class="line">  console.log(v);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// 注意这里是catch</span><br><span class="line">imAsync(0).catch( v =&gt; &#123;</span><br><span class="line">  console.log(v);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">const imAsync1 =  (num) =&gt; &#123;</span><br><span class="line">  return new Promise ( (resolve, reject) =&gt; &#123;</span><br><span class="line">        if (num &gt; 0) &#123;</span><br><span class="line">            resolve(num)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            reject(num)</span><br><span class="line">        &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">imAsync1(1).then( v =&gt; &#123;</span><br><span class="line">  console.log(v);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">imAsync1(0).catch( v =&gt; &#123;</span><br><span class="line">  console.log(v);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="await"><a href="#await" class="headerlink" title="await"></a>await</h4><p>await会暂停当前async函数的执行，等待Promise的计算结果返回以后再继续执行当前的async函数<br>    – await 等待的不是所有的异步操作，等待的只是Promise<br>    – await命令后面是一个thenable对象（即定义then方法的对象），那么await会将其等同于 Promise 对象<br>    – 任何一个await语句后面的 Promise 对象变为reject状态，那么整个async函数都会中断执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">const awaitTest = async () =&gt; &#123;</span><br><span class="line">  console.log(1);  </span><br><span class="line">  await setTimeout(function () &#123;</span><br><span class="line">    console.log(2);</span><br><span class="line">  &#125;, 1000);</span><br><span class="line">  console.log(3);</span><br><span class="line">&#125;</span><br><span class="line">awaitTest()</span><br><span class="line"></span><br><span class="line">const awaitTest = async () =&gt; &#123;</span><br><span class="line">  console.log(1);  </span><br><span class="line">  await new Promise ( (resolve, reject) =&gt; &#123;</span><br><span class="line">    setTimeout(function () &#123;</span><br><span class="line">        console.log(2);</span><br><span class="line">        console.time(&apos;beigin&apos;)</span><br><span class="line">        resolve()</span><br><span class="line">    &#125;, 1000);</span><br><span class="line">  &#125;)</span><br><span class="line">  console.timeEnd(&apos;beigin&apos;)</span><br><span class="line">  console.log(3);</span><br><span class="line">&#125;</span><br><span class="line">awaitTest()</span><br></pre></td></tr></table></figure></p>
<h3 id="async函数对-Generator函数的改进"><a href="#async函数对-Generator函数的改进" class="headerlink" title="async函数对 Generator函数的改进"></a>async函数对 Generator函数的改进</h3><p>（1）内置执行器<br>Generator 函数的执行必须靠执行器，所以才有了co模块，而async函数自带执行器。也就是说，<br>（2）更好的语义<br>（3）更广的适用性<br>（4）返回值是 Promise</p>
<p>await用于一个异步操作之前，表示要“等待”这个异步操作的返回值。await也可以用于一个同步的值。<br>co 函数库其实就是将两种自动执行器（Thunk 函数和 Promise 对象），包装成一个库<br>接受 Generator 函数作为参数，返回一个 Promise 对象，不用编写 Generator 函数的执行器</p>
<p><img src="../images/co1.png" alt=""><br><img src="../images/co2.png" alt=""><br>toPromise<br>通过判定参数的类型，然后再通过转移控制权给不同的参数处理函数，从而获取到期望返回的值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">function toPromise(obj) &#123;</span><br><span class="line">  if (!obj) return obj;</span><br><span class="line">  if (isPromise(obj)) return obj;</span><br><span class="line">  if (isGeneratorFunction(obj) || isGenerator(obj)) return co.call(this, obj);</span><br><span class="line">  if (&apos;function&apos; == typeof obj) return thunkToPromise.call(this, obj);</span><br><span class="line">  if (Array.isArray(obj)) return arrayToPromise.call(this, obj);</span><br><span class="line">  if (isObject(obj)) return objectToPromise.call(this, obj);</span><br><span class="line">  return obj;</span><br><span class="line">&#125;</span><br><span class="line">function objectToPromise(obj)&#123;</span><br><span class="line">  //获取一个和传入的对象一样构造器的对象</span><br><span class="line">  var results = new obj.constructor();</span><br><span class="line">  //获取对象的所有可以遍历的key</span><br><span class="line">  var keys = Object.keys(obj);</span><br><span class="line">  var promises = [];</span><br><span class="line">  for (var i = 0; i &lt; keys.length; i++) &#123;</span><br><span class="line">    var key = keys[i];</span><br><span class="line">    //每一个项都调用一次toPromise方法，变成Promise对象</span><br><span class="line">    var promise = toPromise.call(this, obj[key]);</span><br><span class="line">    //如果里面是Promise对象的话，则取出e里面resolved后的值</span><br><span class="line">    if (promise &amp;&amp; isPromise(promise)) defer(promise, key);</span><br><span class="line">    else results[key] = obj[key];</span><br><span class="line">  &#125;</span><br><span class="line">  //并行，按顺序返回结果，返回一个数组</span><br><span class="line">  return Promise.all(promises).then(function () &#123;</span><br><span class="line">    return results;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  function defer(promise, key) &#123;</span><br><span class="line">    results[key] = undefined;</span><br><span class="line">    promises.push(promise.then(function (res) &#123;</span><br><span class="line">      results[key] = res;</span><br><span class="line">    &#125;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">function thunkToPromise(fn) &#123;</span><br><span class="line">  var ctx = this;</span><br><span class="line">  return new Promise(function (resolve, reject) &#123;</span><br><span class="line">    fn.call(ctx, function (err, res) &#123;</span><br><span class="line">      if (err) return reject(err);</span><br><span class="line">      if (arguments.length &gt; 2) res = slice.call(arguments, 1);</span><br><span class="line">      resolve(res);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line">function arrayToPromise(obj) &#123;</span><br><span class="line">  return Promise.all(obj.map(toPromise, this));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function isPromise(obj) &#123;</span><br><span class="line">  return &apos;function&apos; == typeof obj.then;</span><br><span class="line">&#125;</span><br><span class="line">function isGenerator(obj) &#123;</span><br><span class="line">  return &apos;function&apos; == typeof obj.next &amp;&amp; &apos;function&apos; == typeof obj.throw;</span><br><span class="line">&#125;</span><br><span class="line">function isGeneratorFunction(obj) &#123;</span><br><span class="line">  var constructor = obj.constructor;</span><br><span class="line">  if (!constructor) return false;</span><br><span class="line">  if (&apos;GeneratorFunction&apos; === constructor.name || &apos;GeneratorFunction&apos; === constructor.displayName) return true;</span><br><span class="line">  return isGenerator(constructor.prototype);</span><br><span class="line">&#125;</span><br><span class="line">function isObject(val) &#123;</span><br><span class="line">  return Object == val.constructor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="async-await-错误处理"><a href="#async-await-错误处理" class="headerlink" title="async/await 错误处理"></a>async/await 错误处理</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">async function f() &#123;</span><br><span class="line">  await Promise.reject(&apos;出错了&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f()</span><br><span class="line">.then(v =&gt; console.log(&apos;1&apos;, v))</span><br><span class="line">.catch(e =&gt; console.log(&apos;错误&apos;, e))</span><br><span class="line">// 出错了</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">async function f() &#123;</span><br><span class="line">  let a = await Promise.reject(&apos;hello world1&apos;);</span><br><span class="line">  let b = await Promise.resolve(&apos;hello world2&apos;); // 不会执行</span><br><span class="line">  console.log(a, b)</span><br><span class="line">&#125;</span><br><span class="line">f()</span><br><span class="line">.then(v =&gt; console.log(&apos;1&apos;, v))</span><br><span class="line">.then(v =&gt; console.log(&apos;2&apos;, v))</span><br><span class="line">.catch(e =&gt; console.log(&apos;错误&apos;, e))</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">async function f() &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    await Promise.reject(&apos;出错了&apos;);</span><br><span class="line">  &#125; catch(e) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  return await Promise.resolve(&apos;hello world&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f()</span><br><span class="line">.then(v =&gt; console.log(v))</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">async function f() &#123;</span><br><span class="line">  await Promise.reject(&apos;出错了&apos;)</span><br><span class="line">    .catch(e =&gt; console.log(e));</span><br><span class="line">  return await Promise.resolve(&apos;hello world&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f()</span><br><span class="line">.then(v =&gt; console.log(v))</span><br><span class="line">// 出错了</span><br><span class="line">// hello world</span><br></pre></td></tr></table></figure>
<p>如果有多个await命令，可以统一放在try…catch结构中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">async function main() &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    const val1 = await Promise.reject(&apos;出错了&apos;);</span><br><span class="line">    const val2 = await Promise.resolve(&apos;爱你1&apos;);</span><br><span class="line">    const val3 = await Promise.resolve(&apos;爱你2&apos;);</span><br><span class="line"></span><br><span class="line">    console.log(&apos;Final: &apos;, val2);</span><br><span class="line">  &#125;</span><br><span class="line">  catch (err) &#123;</span><br><span class="line">    console.error(&apos;error&apos;, err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">main()</span><br></pre></td></tr></table></figure></p>
<p>try…catch结构，实现多次重复尝试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">const NUM_RETRIES = 3;</span><br><span class="line">async function test() &#123;</span><br><span class="line">  let i;</span><br><span class="line">  for (i = 0; i &lt; NUM_RETRIES; ++i) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      await Promise.resolve(&apos;出错了&apos;);</span><br><span class="line">      break;</span><br><span class="line">    &#125; catch(err) &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  console.log(i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test();</span><br></pre></td></tr></table></figure>
<p>多个await命令后面的异步操作，如果不存在继发关系，最好让它们同时触发<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let [foo, bar] = await Promise.all([getFoo(), getBar()]);</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/11/27/promise实践分享/" rel="next" title="Promise实践">
                <i class="fa fa-chevron-left"></i> Promise实践
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#一道题"><span class="nav-number">1.</span> <span class="nav-text">一道题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#理解async-await"><span class="nav-number">2.</span> <span class="nav-text">理解async/await</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#async"><span class="nav-number">2.1.</span> <span class="nav-text">async</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#await"><span class="nav-number">2.2.</span> <span class="nav-text">await</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#async函数对-Generator函数的改进"><span class="nav-number">3.</span> <span class="nav-text">async函数对 Generator函数的改进</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#async-await-错误处理"><span class="nav-number">4.</span> <span class="nav-text">async/await 错误处理</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
